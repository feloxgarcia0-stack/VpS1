name: Laboratorio Kali con Notificacion a Discord

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Crear Entorno Kali y Obtener SSH
        # Le damos un ID a este paso para poder usar su output más tarde
        id: setup
        run: |
          echo "### Creando contenedor Kali..."
          docker run --rm -d --name kali kalilinux/kali-rolling tail -f /dev/null

          echo "### Instalando herramientas y tmate..."
          docker exec kali apt-get update
          docker exec kali apt-get install -yq tmate curl htop golang-go default-jdk nodejs npm nmap sqlmap 

          echo "### Configurando tmate sin barra verde..."
          docker exec kali bash -c "echo 'set -g status off' > /root/.tmate.conf"

          echo "### Obteniendo la conexión SSH..."
          tmate_ssh=$(docker exec kali tmate -S /tmp/tmate.sock new-session -d \; wait tmate-ready \; display -p '#{tmate_ssh}')
          
          # Guardamos la conexión como un "output" de este paso para usarla después
          echo "ssh_connection=$tmate_ssh" >> $GITHUB_OUTPUT
      
      # ¡EL PASO CLAVE!
      - name: Enviar Notificación a Discord
        run: |
          # Usamos el output del paso anterior y lo mandamos por el webhook.
          # La sintaxis con '`' formatea el comando para que sea fácil de copiar en Discord.
          curl -H "Content-Type: application/json" -X POST -d \
          '{"content": "✅ **Nueva VPS de Kali lista.**\n\nCopia y pega esto en Termux:\n\n`'${{ steps.setup.outputs.ssh_connection }}'`"}' \
          https://discord.com/api/webhooks/1398292786876387439/Vmc5Ms5ZoF7GYp8yVwKZV1Q6k1Ht97k5tRRDZOG9_TNJQndDzxHx-1XpZYAQrPjtQvmJ

      - name: Mantener viva la conexión
        run: sleep 21000
